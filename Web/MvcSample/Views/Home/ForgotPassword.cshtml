@{
    ViewData["Title"] = "Recuperar Contraseña";
    ViewBag.HideFooter = false;
}

@section Styles {
    <link rel="stylesheet" href="~/css/forgot-password.css" asp-append-version="true" />
}

<div class="login-page">
    <div class="login-card">
        <!-- Header -->
        <div class="login-card-header">
            <div class="login-card-icon recovery-icon">
                <span>🔒</span>
            </div>
            <h1 class="login-title">Recuperar Contraseña</h1>
            <p class="login-subtitle">
                Ingresa tu correo para recuperar tu contraseña
            </p>
        </div>

        <!-- Mensaje de error -->
        <div id="errorMessage" class="login-error" style="display: none;"></div>
        <div id="successMessage" class="login-success" style="display: none;"></div>

        <!-- Formulario -->
        <form id="forgotPasswordForm" class="login-form">
            @Html.AntiForgeryToken()

            <div class="login-field">
                <label for="Email">Correo Electrónico</label>
                <div class="login-input-wrapper">
                    <span class="login-input-icon">
                        &#9993;
                    </span>
                    <input type="email"
                           id="Email"
                           name="email"
                           placeholder="tu@universidad.edu"
                           required />
                </div>
            </div>

            <button type="submit" class="login-button" id="submitBtn">
                <span>Verificar Correo</span>
            </button>
        </form>

        <div class="recovery-back">
            <a asp-action="Index"
               asp-controller="Home"
               class="recovery-back-button">
                Volver al Login
            </a>
        </div>
    </div>
</div>

<!-- Modal para Cambiar Contraseña -->
<div id="changePasswordModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-icon">
                <span>🔑</span>
            </div>
            <h2 class="modal-title">Cambiar Contraseña</h2>
            <p class="modal-subtitle">
                Ingresa tu nueva contraseña
            </p>
        </div>

        <div id="modalErrorMessage" class="login-error" style="display: none;"></div>
        <div id="modalSuccessMessage" class="login-success" style="display: none;"></div>

        <form id="changePasswordForm" class="login-form">
            <input type="hidden" id="modalEmail" />

            <div class="login-field">
                <label for="NewPassword">Nueva Contraseña</label>
                <div class="login-input-wrapper">
                    <span class="login-input-icon">
                        &#128274;
                    </span>
                    <input type="password"
                           id="NewPassword"
                           name="newPassword"
                           placeholder="••••••••"
                           required />
                </div>
            </div>

            <div class="login-field">
                <label for="ConfirmPassword">Confirmar Contraseña</label>
                <div class="login-input-wrapper">
                    <span class="login-input-icon">
                        &#128274;
                    </span>
                    <input type="password"
                           id="ConfirmPassword"
                           name="confirmPassword"
                           placeholder="••••••••"
                           required />
                </div>
            </div>

            <button type="submit" class="login-button" id="changePasswordBtn">
                <span>Cambiar Contraseña</span>
            </button>

            <button type="button" class="recovery-back-button" id="closeModalBtn" style="margin-top: 12px;">
                Cancelar
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let currentEmail = '';

            // Manejar envío del formulario de verificación de email
            $('#forgotPasswordForm').on('submit', async function (e) {
                e.preventDefault();

                const email = $('#Email').val().trim();
                const submitBtn = $('#submitBtn');
                const errorDiv = $('#errorMessage');
                const successDiv = $('#successMessage');

                // Ocultar mensajes previos
                errorDiv.hide();
                successDiv.hide();

                if (!email) {
                    errorDiv.text('Por favor ingresa un correo electrónico.').show();
                    return;
                }

                // Deshabilitar botón mientras procesa
                submitBtn.prop('disabled', true).html('<span>Verificando...</span>');

                try {
                    const response = await fetch('@Url.Action("VerifyEmail", "Home")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: `email=${encodeURIComponent(email)}`
                    });

                    const data = await response.json();

                    if (data.exists) {
                        // Email existe, mostrar modal
                        currentEmail = email;
                        $('#modalEmail').val(email);
                        $('#changePasswordModal').fadeIn(300);
                        successDiv.text(data.message).show();
                    } else {
                        // Email no existe
                        errorDiv.text(data.message).show();
                    }
                } catch (error) {
                    errorDiv.text('Ocurrió un error al verificar el correo. Por favor intenta de nuevo.').show();
                } finally {
                    submitBtn.prop('disabled', false).html('<span>Verificar Correo</span>');
                }
            });

            // Manejar envío del formulario de cambio de contraseña
            $('#changePasswordForm').on('submit', async function (e) {
                e.preventDefault();

                const email = $('#modalEmail').val();
                const newPassword = $('#NewPassword').val();
                const confirmPassword = $('#ConfirmPassword').val();
                const changeBtn = $('#changePasswordBtn');
                const errorDiv = $('#modalErrorMessage');
                const successDiv = $('#modalSuccessMessage');

                // Ocultar mensajes previos
                errorDiv.hide();
                successDiv.hide();

                // Validaciones
                if (!newPassword || !confirmPassword) {
                    errorDiv.text('Todos los campos son requeridos.').show();
                    return;
                }

                if (newPassword.length < 6) {
                    errorDiv.text('La contraseña debe tener al menos 6 caracteres.').show();
                    return;
                }

                if (newPassword !== confirmPassword) {
                    errorDiv.text('Las contraseñas no coinciden.').show();
                    return;
                }

                // Deshabilitar botón mientras procesa
                changeBtn.prop('disabled', true).html('<span>Cambiando...</span>');

                try {
                    const response = await fetch('@Url.Action("ChangePassword", "Home")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: `email=${encodeURIComponent(email)}&newPassword=${encodeURIComponent(newPassword)}&confirmPassword=${encodeURIComponent(confirmPassword)}`
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Éxito
                        successDiv.text(data.message).show();
                        $('#changePasswordForm')[0].reset();
                        
                        // Cerrar modal después de 2 segundos y redirigir
                        setTimeout(function () {
                            window.location.href = '@Url.Action("Index", "Home")';
                        }, 2000);
                    } else {
                        // Error
                        errorDiv.text(data.message).show();
                    }
                } catch (error) {
                    errorDiv.text('Ocurrió un error al cambiar la contraseña. Por favor intenta de nuevo.').show();
                } finally {
                    changeBtn.prop('disabled', false).html('<span>Cambiar Contraseña</span>');
                }
            });

            // Cerrar modal
            $('#closeModalBtn').on('click', function () {
                $('#changePasswordModal').fadeOut(300);
                $('#changePasswordForm')[0].reset();
                $('#modalErrorMessage').hide();
                $('#modalSuccessMessage').hide();
            });

            // Cerrar modal al hacer clic fuera
            $('#changePasswordModal').on('click', function (e) {
                if ($(e.target).is('#changePasswordModal')) {
                    $(this).fadeOut(300);
                    $('#changePasswordForm')[0].reset();
                    $('#modalErrorMessage').hide();
                    $('#modalSuccessMessage').hide();
                }
            });
        });
    </script>
}
